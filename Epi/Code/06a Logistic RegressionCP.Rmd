###
### name: דוד בורג
### ID  : [מספר תעודת זהות]
### course: אפידמיולוגיה (HIT.ac.il)
### lesson: רגרסיה לוגיסטית 06   
### date  : 15/06/2025
###  
###  מלמד לעשות רגסיה לוגיסטית
###


## Reset memory
```{r setup-packages, include false}
rm(list = ls(all.names = TRUE))
lapply(paste('package:',names(sessionInfo()$otherPkgs),sep=""),detach,character.only=TRUE,unload=TRUE,force=TRUE)
gc()
```

```{r setup, include=FALSE}
data<-marrychase_birthsR

model <- glm(anemia ~ lopc, data = data, family = binomial)
  # Calculate Odds Ratios (OR)
  or <- exp(coef(model))
  
  # Calculate 95% Confidence Intervals (CI)
  ci <- exp(confint(model))
  
  or
  ci
summary(model)



# Create a new data frame for prediction
new_data <- data.frame(lopc = c(0, 1))

# Calculate predicted probabilities
predicted_probabilities <- predict(model, newdata = new_data, type = "response")
predicted_probabilities

```


```{r , echo=FALSE}
install.packages("ResourceSelection")
install.packages("broom")

library(ResourceSelection)
library(broom)

data_clean <- na.omit(data[c("anemia", "lopc","MomAge","race")])

# logistic regression model
model <- glm(anemia ~ lopc +MomAge+ race, data = data_clean, family = binomial)
summary(model)

#Odds Ratios and 95% Confidence Intervals
odds_ratios <- exp(coef(model))
conf_int <- exp(confint(model))

# Display Odds Ratios and Confidence Intervals
odds_ratios
conf_int
summary(model)





###godness of fit and model preformance


##-2LL
#logistic regression model
full_model <- glm(anemia ~ lopc +MomAge+ race, data = data_clean, family = binomial)

# null model (intercept-only model)
null_model <- glm(anemia ~ 1, data = data_clean, family = binomial)

# Summary of the full model to get the number of iterations
summary(full_model)

#  the -2 Log Likelihood for the full model
log_likelihood_full <- -2 * logLik(full_model)

#the -2 Log Likelihood for the null model
log_likelihood_null <- -2 * logLik(null_model)

# the chi-square statistic for the omnibus test
chi_square_stat <- log_likelihood_null - log_likelihood_full

# Degrees of freedom is the difference in the number of parameters between the models
df <- df.residual(null_model) - df.residual(full_model)

# Calculate the p-value for the chi-square statistic
p_value <- pchisq(chi_square_stat, df, lower.tail = FALSE)

# iterations 
iterations <- summary(full_model)$iter

# Print the results
cat("-2 Log Likelihood for the full model:", log_likelihood_full, "\n")
cat("-2 Log Likelihood for the null model:", log_likelihood_null, "\n")
cat("Chi-square statistic for the omnibus test:", chi_square_stat, "\n")
cat("Degrees of freedom:", df, "\n")
cat("P-value for the omnibus test:", p_value, "\n")
cat("Number of iterations:", iterations, "\n")

##classification table

#predicted probabilities
predicted_prob <- ifelse(fitted(model) > 0.5, 1, 0)

# classification table
classification_table <- table(predicted = predicted_prob, actual = data_clean$anemia)

# Print  classification table
print(classification_table)

true_positive <- ifelse("1" %in% rownames(classification_table) & "1" %in% colnames(classification_table),
                        classification_table["1", "1"], 0)
true_negative <- ifelse("0" %in% rownames(classification_table) & "0" %in% colnames(classification_table),
                        classification_table["0", "0"], 0)
false_positive <- ifelse("1" %in% rownames(classification_table) & "0" %in% colnames(classification_table),
                         classification_table["1", "0"], 0)
false_negative <- ifelse("0" %in% rownames(classification_table) & "1" %in% colnames(classification_table),
                         classification_table["0", "1"], 0)

# Calculate sensitivity and specificity
sensitivity <- true_positive / (true_positive + false_negative)
specificity <- true_negative / (true_negative + false_positive)



sensitivity
specificity 



###R square
install.packages("rms")
library(rms)
model_rms <- lrm(anemia ~ lopc +MomAge+ race, data = data_clean)
nagelkerke_r2 <- model_rms$stats["R2"]
nagelkerke_r2
```


```{r , echo=FALSE}
predicted_probabilities <- predict(model, type = "response")



#  new data frame for the specific case where lopc = 1 and race = 1
new_data <- data.frame(lopc = 1, race = 1)

# Predict the probability for the specific case
case_probability <- predict(model, newdata = new_data, type = "response")
case_probability
```


```{r , echo=FALSE}
install.packages("pROC")
library(pROC)

data_clean <- na.omit(data[c("anemia", "lopc", "race", "MomAge")])

# logistic regression model on the cleaned data
model <- glm(anemia ~ lopc + race + MomAge, data = data_clean, family = binomial)


#  predicted probabilities for all observations
predicted_probabilities <- predict(model, type = "response")

# ROC analysis
roc_analysis <- roc(data_clean$anemia, predicted_probabilities)

print(roc_analysis)

# ROC curve
plot(roc_analysis, main = "ROC Curve for Anemia Prediction",
     col = "blue", lwd = 2, xlab = "1 - Specificity", ylab = "Sensitivity")


# Calculate the confidence interval for the AUC
ci_auc <- ci.auc(roc_analysis)
print(ci_auc)




```

