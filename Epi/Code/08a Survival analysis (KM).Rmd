###
### name: דוד בורג
### ID  : [מספר תעודת זהות]
### course: אפידמיולוגיה (HIT.ac.il)
### lesson: שרידות 08   Survival
### date  : 25/06/2025
###  
###  נלמד לבצע ניתוח שרידות 
###
### source:  https://bookdown.org/drki_musa/dataanalysis/survival-analysis-kaplan-meier-and-cox-proportional-hazard-ph-regression.html#kaplan-meier-survival-estimates


## Reset memory
```{r setup-packages, include false}
rm(list = ls(all.names = TRUE))
lapply(paste('package:',names(sessionInfo()$otherPkgs),sep=""),detach,character.only=TRUE,unload=TRUE,force=TRUE)
gc()
dev.off()
```

## Load required packages
```{r load-packages, include false}
options("install.lock"=FALSE)
if (!require("pacman")) install.packages("pacman")
library(pacman)
pacman::p_load(
  rio,          # File import
  tidyverse,    # data management + ggplot2 graphics, 
  gt,           # Nice beuatiful tables
  nortest,      # Anderson-Darling test for normality
  ggplot2,      # For creating plots
  DescTools,    # For statistical functions like skewness and kurtosis
  janitor,      # adding totals and percents to tables
  car,           # For Levene's test and ANOVA
  gtsummary,    # summary statistics and tests
  corrr,        # correlation analayis for numeric variables
  dplyr,        # For data manipulation
  reshape2,     # For reshaping data
  skimr,        # get overview of data
  performance,           # For model performance metrics
  ResourceSelection,     # For goodness of fit tests
  broom,                 # For tidying model outputs
  pROC,                  # For ROC analysis
  caret,
  MASS,          # For statistical functions (polr for ordinal regression)
  epiDisplay,    # 
  survival,
  survminer
            )
```

## Access the data
```{r read-data, echo=FALSE}
## read the data in a file online
# file <- "./EpiData/stroke_data.csv"     # use this if the file is on your computer
file <- "https://raw.githubusercontent.com/drkamarul/multivar_data_analysis/refs/heads/main/data/stroke_data.csv"
df6 <- import(file, trust  = TRUE)
summary(df6)
glimpse(df6)
```

## Clean the data
```{r read-data, echo=FALSE}
# convert the variable doa and variable doa to a more valid format (date format)
df6 <- 
  df6 %>%
  mutate(doa = dmy(doa),
         dod = dmy(dod))
```

## Show the data
```{r read-data, echo=FALSE}
# in a nice table
df6 %>%
  tbl_summary(by = status) %>%
  as_gt()

df6 %>%
  tbl_summary(by = stroke_type) %>%
  as_gt()
```

## Do a Kaplan-Meyer survival analayis
```{r read-data, echo=FALSE}
# estimate the survival probabilities for all patients
KM_all <- survfit(Surv(time = time2, 
                   event = status == "dead" ) ~ 1, 
              data = df6)
summary(KM_All)

# estimate the survival probabilities for stroke type
KM_str_type <- survfit(Surv(time = time2, 
                             event = status == "dead" ) ~ stroke_type, 
                        data = df6)
summary(KM_str_type)
```

## Kaplan-Meyer survival analayis plot
```{r read-data, echo=FALSE}
# estimate the survival probabilities for all patients
KM_plot <- ggsurvplot(KM_str_type, 
           data = df6, 
           risk.table = TRUE, 
           linetype = c(1,4),
           tables.height = 0.3,
           pval = TRUE)

print(KM_plot)
# *** You may need to zoom out ***
```

## Log-rank test
```{r read-data, echo=FALSE}
# Test if survival estimates are  different between levels/groups
log_rank_stroke <- survdiff(Surv(time = time2, 
              event = status == "dead") ~ stroke_type, 
         data = df6,
         rho = 0)

log_rank_stroke

# Test if survival estimates are  different between levels/groups
log_rank_diabetes <- survdiff(Surv(time = time2, 
              event = status == "dead") ~ dm, 
         data = df6,
         rho = 0)

log_rank_diabetes
```

## Peto's log-rank test
```{r read-data, echo=FALSE}
# Test if survival estimates are  different between levels/groups
log_rank_stroke <- survdiff(Surv(time = time2, 
              event = status == "dead") ~ stroke_type, 
         data = df6,
         rho = 1)

log_rank_stroke

# Test if survival estimates are  different between levels/groups
log_rank_diabetes <- survdiff(Surv(time = time2, 
              event = status == "dead") ~ dm, 
         data = df6,
         rho = 1)

log_rank_diabetes
```

## Life table
```{r read-data, echo=FALSE}
KM_str_type <- survfit(Surv(time = time2, event = status == "dead") ~ stroke_type, data = df6)
KM_str_type
```

## Life table (with different time inveral, eg 30 days )
```{r read-data, echo=FALSE}
KM_str_type_cut <- summary(KM_str_type, times = seq(0, max(df6$time2), by = 30))
KM_str_type_cut
```

## Display a nice table
```{r read-data, echo=FALSE}
# Create a df from values in the analysis
life_df <- data.frame(
  time      = KM_str_type_cut$time,
  strata    = KM_str_type_cut$strata,
  n_risk    = KM_str_type_cut$n.risk,
  n_event   = KM_str_type_cut$n.event,
  survival  = KM_str_type_cut$surv,
  lower_ci  = KM_str_type_cut$lower,
  upper_ci  = KM_str_type_cut$upper
)

# Dsiaply the table
life_df %>%
  mutate(
    time = paste0(time, " days"),
    survival = round(survival, 3),
    lower_ci = round(lower_ci, 3),
    upper_ci = round(upper_ci, 3)
  ) %>%
  gt() %>%
  tab_header(
    title = "Kaplan-Meier Life Table by Stroke Type",
    subtitle = "Interval: every 30 days"
  ) %>%
  cols_label(
    time = "Time",
    strata = "Stroke Type",
    n_risk = "At Risk",
    n_event = "Events",
    survival = "Survival",
    lower_ci = "Lower CI",
    upper_ci = "Upper CI"
  ) %>%
  fmt_missing(everything(), missing_text = "-")
```
















```{r setup, include=FALSE}
data<-birth_survivalR
```

```{r until 15, echo=FALSE}
install.packages("survival")
install.packages("survminer")
install.packages("broom")

library(broom)
library(survival)
library(survminer)
library(dplyr)


##question 2
# Creating the Surv object
surv_obj_1 <- Surv(time = data$time_to_anemia, event = data$anemia1)

# survival model
fit1<- survfit(surv_obj_1 ~ 1)

# Extract summary from the fit for intervals up to 15 days
fit_summary1 <- summary(fit1, times = seq(0, 15, by = 1))

# Create  life table
life_table <- data.frame(
  time = fit_summary1$time,
  n_risk = fit_summary1$n.risk,
  n_event = fit_summary1$n.event,
  n_censor = fit_summary1$n.censor
)



# Calculate the number exposed to risk accounting for half the censored individuals
life_table <- life_table %>%
  mutate(exposed_to_risk = n_risk - 0.5 * n_censor)

# Calculate the survival proportion at each interval
life_table <- life_table %>%
  mutate(survival_proportion = 1 - (n_event / exposed_to_risk))

# Calculate the cumulative survival proportion
life_table <- life_table %>%
  mutate(cumulative_survival = cumprod(survival_proportion))

# Print the life table
print(life_table)
```

```{r cars}
###question 3


#  Surv object
surv_obj <- Surv(time = data$time_to_anemia, event = data$anemia1)

# Fit the survival model
fit <- survfit(surv_obj ~ 1)
#for maximum time
fit_summary <- summary(fit, times = seq(0, max(data$time_to_anemia, na.rm = TRUE), by = 1))

# Create the life table
life_table <- data.frame(
  time = fit_summary$time,
  n_risk = fit_summary$n.risk,
  n_event = fit_summary$n.event,
  n_censor = fit_summary$n.censor
)

# Calculate the number exposed to risk accounting for half the censored individuals
life_table <- life_table %>%
  mutate(exposed_to_risk = n_risk - 0.5 * n_censor)

# Calculate the survival proportion at each interval
life_table <- life_table %>%
  mutate(survival_proportion = 1 - (n_event / exposed_to_risk))

# Calculate the cumulative survival proportion
life_table <- life_table %>%
  mutate(cumulative_survival = cumprod(survival_proportion))

# Print the life table
print(life_table)


# Create the survival plot
ggsurvplot(fit, data = data, conf.int = TRUE,
           ggtheme = theme_minimal(),
           risk.table = FALSE, # Add risk table
           pval = FALSE)       # Add p-value of the log-rank test


```

```{r cars}
##question 4

surv_obj <- Surv(time = data$time_to_anemia, event = data$anemia1)

# Fit the survival model


# Fit the survival model stratified by race
fit <- survfit(surv_obj ~ race, data = data)

# Extract the summary from the fit with intervals of one unit for each race group
fit_summary <- summary(fit, times = seq(0, max(data$time_to_anemia, na.rm = TRUE), by = 1))

# Initialize an empty data frame for the life table
life_table <- data.frame()

# Loop through each race group to create life tables
for (i in seq_along(fit$strata)) {
  race_group <- names(fit$strata)[i]
  race_summary <- summary(fit[i], times = seq(0, max(data$time_to_anemia, na.rm = TRUE), by = 1))
  
  race_life_table <- data.frame(
    race = race_group,
    time = race_summary$time,
    n_risk = race_summary$n.risk,
    n_event = race_summary$n.event,
    n_censor = race_summary$n.censor
  )
  
  # Calculate the number exposed to risk accounting for half the censored individuals
  race_life_table <- race_life_table %>%
    mutate(exposed_to_risk = n_risk - 0.5 * n_censor)
  
  # Calculate the survival proportion at each interval
  race_life_table <- race_life_table %>%
    mutate(survival_proportion = 1 - (n_event / exposed_to_risk))
  
  # Calculate the cumulative survival proportion
  race_life_table <- race_life_table %>%
    mutate(cumulative_survival = cumprod(survival_proportion))
  
  # Append to the main life table data frame
  life_table <- rbind(life_table, race_life_table)
}


# Print the life table
print(life_table)
```

```{r cars}

#KM


# Plot Kaplan-Meier survival curves
ggsurvplot(
  fit,
  data = data,
  conf.int = TRUE,
  pval = TRUE,
  risk.table = FALSE,
  ggtheme = theme_minimal(),
  title = "Kaplan-Meier Survival Curves by Race Group",
  xlab = "Time to Anemia",
  ylab = "Survival Probability"
)



 print(fit,print.rmean = T)

 
 
 # Perform the log-rank test not mandatory 
log_rank_test <- survdiff(surv_obj ~ race, data = data)

# Print the results of the log-rank test
print(log_rank_test)

# Calculate the p-value
p_value <- 1 - pchisq(log_rank_test$chisq, length(log_rank_test$n) - 1)
p_value







###KAPLAN survival table


km_table <- data.frame()

for (i in seq_along(fit$strata)) {
  race_group <- names(fit$strata)[i]
  # TRUE KM: No "times = ..." so we get real event time points
  km_summary <- summary(fit[i])

  stratum_df <- data.frame(
    race = race_group,
    time = km_summary$time,
    n_risk = km_summary$n.risk,
    n_event = km_summary$n.event,
    n_censor = km_summary$n.censor,
    survival = km_summary$surv,
    std_err = km_summary$std.err,
    lower_CI = km_summary$lower,
    upper_CI = km_summary$upper
  )

  km_table <- rbind(km_table, stratum_df)
}

print(km_table)


```


